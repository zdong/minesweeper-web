@page "/"
@page "/game"
@using Minesweeper.Core
@using Minesweeper.Core.Models
@using Minesweeper.Core.Solver
@using Minesweeper.Web.Services
@using Minesweeper.Web.Models
@inject ScoreService ScoreService

<PageTitle>Minesweeper</PageTitle>

<div class="game-container">
    <div class="header">
        <div class="mine-counter">@RemainingMines.ToString("D3")</div>
        <button class="smiley-btn" @onclick="NewGame">@SmileyFace</button>
        <div class="timer">@ElapsedSeconds.ToString("D3")</div>
    </div>

    <div class="difficulty-selector">
        <button class="@(CurrentDifficulty == "Beginner" ? "active" : "")" @onclick="SetBeginner">Beginner</button>
        <button class="@(CurrentDifficulty == "Intermediate" ? "active" : "")" @onclick="SetIntermediate">Intermediate</button>
        <button class="@(CurrentDifficulty == "Expert" ? "active" : "")" @onclick="SetExpert">Expert</button>
    </div>

    <div class="board" style="grid-template-columns: repeat(@_board.Columns, 30px);">
        @for (int r = 0; r < _board.Rows; r++)
        {
            @for (int c = 0; c < _board.Columns; c++)
            {
                var row = r;
                var col = c;
                var cell = _board.GetCell(row, col)!;
                <div class="cell @GetCellClass(cell)"
                     @onclick="() => RevealCell(row, col)"
                     @oncontextmenu="() => ToggleFlag(row, col)"
                     @oncontextmenu:preventDefault="true">
                    @GetCellContent(cell)
                </div>
            }
        }
    </div>

    <div class="controls">
        <button @onclick="StartAI" disabled="@_aiRunning">@(_aiRunning ? "AI Running..." : "AI Auto-Play")</button>
        <button @onclick="StopAI" disabled="@(!_aiRunning)">Stop AI</button>
    </div>

    @if (!string.IsNullOrEmpty(_botWarning))
    {
        <div class="bot-warning">
            <span class="robot-icon">ðŸ¤–</span>
            <span>@_botWarning</span>
            @if (_suspicionLevel >= 6)
            {
                <div class="bot-confirmed">Score submission disabled for suspected bots!</div>
            }
        </div>
    }

    @if (_board.State == GameState.Won)
    {
        <div class="message win">
            <div>You Win! Time: @ElapsedSeconds seconds</div>
            @if (!_scoreSubmitted && !_isAiGame)
            {
                <div class="score-submit">
                    <input type="text" @bind="_playerName" placeholder="Enter your name" maxlength="20" />
                    <button @onclick="SubmitScore" disabled="@_submittingScore">
                        @(_submittingScore ? "Submitting..." : "Submit Score")
                    </button>
                </div>
            }
            @if (_scoreSubmitted)
            {
                <div class="score-submitted">Score submitted!</div>
            }
        </div>
    }
    @if (_board.State == GameState.Lost)
    {
        <div class="message lose">Game Over!</div>
    }

    <div class="scoreboard-section">
        <h3>Leaderboard</h3>
        <div class="scoreboard-tabs">
            <button class="@(_scoreboardTab == "daily" ? "active" : "")" @onclick='() => LoadScores("daily")'>Today</button>
            <button class="@(_scoreboardTab == "weekly" ? "active" : "")" @onclick='() => LoadScores("weekly")'>This Week</button>
            <button class="@(_scoreboardTab == "alltime" ? "active" : "")" @onclick='() => LoadScores("alltime")'>All Time</button>
        </div>
        <div class="scoreboard">
            @if (_loadingScores)
            {
                <div class="loading">Loading...</div>
            }
            else if (_scores.Count == 0)
            {
                <div class="no-scores">No scores yet. Be the first!</div>
            }
            else
            {
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Player</th>
                            <th>Time</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < _scores.Count; i++)
                        {
                            var score = _scores[i];
                            <tr>
                                <td>@(i + 1)</td>
                                <td>@score.PlayerName</td>
                                <td>@score.TimeSeconds s</td>
                                <td>@score.CreatedAt.ToLocalTime().ToString("MM/dd")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>
</div>

@code {
    private GameBoard _board = null!;
    private DifficultySettings _settings = GameConstants.Beginner;
    private string CurrentDifficulty = "Beginner";
    private System.Timers.Timer? _timer;
    private int ElapsedSeconds = 0;
    private bool _aiRunning = false;
    private CancellationTokenSource? _aiCts;

    private string _playerName = "";
    private bool _scoreSubmitted = false;
    private bool _submittingScore = false;
    private bool _isAiGame = false;
    private List<Score> _scores = new();
    private bool _loadingScores = false;
    private string _scoreboardTab = "daily";

    // Bot detection
    private List<double> _clickIntervals = new();
    private DateTime _lastClickTime = DateTime.MinValue;
    private int _suspicionLevel = 0;
    private string _botWarning = "";

    private int RemainingMines => _board.MineCount - _board.GetFlagCount();
    private string SmileyFace => _board.State switch
    {
        GameState.Won => "ðŸ˜Ž",
        GameState.Lost => "ðŸ˜µ",
        _ => "ðŸ™‚"
    };

    protected override async Task OnInitializedAsync()
    {
        NewGame();
        await LoadScores("daily");
    }

    private void NewGame()
    {
        StopAI();
        _board = new GameBoard(_settings);
        ElapsedSeconds = 0;
        _scoreSubmitted = false;
        _isAiGame = false;
        _clickIntervals.Clear();
        _lastClickTime = DateTime.MinValue;
        _suspicionLevel = 0;
        _botWarning = "";
        _timer?.Stop();
        _timer = new System.Timers.Timer(1000);
        _timer.Elapsed += (s, e) =>
        {
            if (_board.State == GameState.InProgress)
            {
                ElapsedSeconds++;
                InvokeAsync(StateHasChanged);
            }
        };
    }

    private void SetBeginner() => SetDifficulty(GameConstants.Beginner, "Beginner");
    private void SetIntermediate() => SetDifficulty(GameConstants.Intermediate, "Intermediate");
    private void SetExpert() => SetDifficulty(GameConstants.Expert, "Expert");

    private void SetDifficulty(DifficultySettings settings, string name)
    {
        _settings = settings;
        CurrentDifficulty = name;
        NewGame();
    }

    private void RevealCell(int row, int col)
    {
        if (_aiRunning) return;

        // Bot detection: track click timing
        var now = DateTime.Now;
        if (_lastClickTime != DateTime.MinValue)
        {
            var interval = (now - _lastClickTime).TotalMilliseconds;
            _clickIntervals.Add(interval);
            CheckForBot();
        }
        _lastClickTime = now;

        var prevState = _board.State;
        _board.RevealCell(row, col);
        if (prevState == GameState.NotStarted && _board.State == GameState.InProgress)
            _timer?.Start();
        if (_board.State == GameState.Won || _board.State == GameState.Lost)
            _timer?.Stop();
    }

    private void ToggleFlag(int row, int col)
    {
        if (_aiRunning) return;
        _board.ToggleFlag(row, col);
    }

    private string GetCellClass(Cell cell)
    {
        if (!cell.IsRevealed)
            return cell.IsFlagged ? "unrevealed flagged" : "unrevealed";
        if (cell.IsMine)
            return cell.IsTriggered ? "mine triggered" : "mine";
        return $"revealed n{cell.AdjacentMines}";
    }

    private string GetCellContent(Cell cell)
    {
        if (!cell.IsRevealed)
            return cell.IsFlagged ? "ðŸš©" : "";
        if (cell.IsMine)
            return "ðŸ’£";
        return cell.AdjacentMines > 0 ? cell.AdjacentMines.ToString() : "";
    }

    private async void StartAI()
    {
        if (_aiRunning) return;
        _aiRunning = true;
        _isAiGame = true;
        _aiCts = new CancellationTokenSource();
        var solver = new MinesweeperSolver(_board);

        await Task.Run(async () =>
        {
            while (!_aiCts.Token.IsCancellationRequested &&
                   _board.State != GameState.Won &&
                   _board.State != GameState.Lost)
            {
                var move = solver.GetNextMove();
                if (move == null) break;

                await InvokeAsync(() =>
                {
                    if (_board.State == GameState.NotStarted)
                        _timer?.Start();
                    if (move.Action == MoveAction.Reveal)
                        _board.RevealCell(move.Row, move.Column);
                    else
                        _board.ToggleFlag(move.Row, move.Column);
                    StateHasChanged();
                });

                await Task.Delay(50, _aiCts.Token);
            }
            await InvokeAsync(() =>
            {
                _aiRunning = false;
                _timer?.Stop();
                StateHasChanged();
            });
        });
    }

    private void StopAI()
    {
        _aiCts?.Cancel();
        _aiRunning = false;
    }

    private async Task SubmitScore()
    {
        if (string.IsNullOrWhiteSpace(_playerName) || _scoreSubmitted) return;

        _submittingScore = true;
        StateHasChanged();

        var success = await ScoreService.SaveScoreAsync(_playerName.Trim(), CurrentDifficulty, ElapsedSeconds);

        if (success)
        {
            _scoreSubmitted = true;
            await LoadScores(_scoreboardTab);
        }

        _submittingScore = false;
        StateHasChanged();
    }

    private async Task LoadScores(string tab)
    {
        _scoreboardTab = tab;
        _loadingScores = true;
        StateHasChanged();

        _scores = tab switch
        {
            "daily" => await ScoreService.GetDailyTopScoresAsync(CurrentDifficulty),
            "weekly" => await ScoreService.GetWeeklyTopScoresAsync(CurrentDifficulty),
            "alltime" => await ScoreService.GetAllTimeTopScoresAsync(CurrentDifficulty),
            _ => new List<Score>()
        };

        _loadingScores = false;
        StateHasChanged();
    }

    private static readonly string[] BotWarnings = new[]
    {
        "Hmm... you're clicking awfully fast there, friend.",
        "Are you a robot? Blink twice if you need help.",
        "I've seen bots click slower than this!",
        "Whoa there, Speedy McClickface!",
        "My robot senses are tingling...",
        "Either you're a bot, or you've had WAY too much coffee.",
        "Beep boop? Is that you, fellow robot?",
        "The machines are taking over! Oh wait, that might be you.",
        "Human verification failed. Just kidding... or am I?",
        "You click with the precision of a thousand CPUs.",
    };

    private void CheckForBot()
    {
        if (_clickIntervals.Count < 5) return;

        // Get last 10 intervals (or less if not available)
        var recentIntervals = _clickIntervals.TakeLast(10).ToList();

        // Calculate average and standard deviation
        var avg = recentIntervals.Average();
        var stdDev = Math.Sqrt(recentIntervals.Average(x => Math.Pow(x - avg, 2)));

        // Bot indicators:
        // 1. Very fast clicks (avg < 150ms)
        // 2. Very consistent timing (low standard deviation < 50ms)
        // 3. Suspiciously robotic pattern

        bool isSuspiciouslyFast = avg < 150;
        bool isSuspiciouslyConsistent = stdDev < 50 && recentIntervals.Count >= 5;

        if (isSuspiciouslyFast && isSuspiciouslyConsistent)
        {
            _suspicionLevel = Math.Min(_suspicionLevel + 2, 10);
        }
        else if (isSuspiciouslyFast || isSuspiciouslyConsistent)
        {
            _suspicionLevel = Math.Min(_suspicionLevel + 1, 10);
        }
        else
        {
            _suspicionLevel = Math.Max(_suspicionLevel - 1, 0);
        }

        // Show warning at different suspicion levels
        if (_suspicionLevel >= 3 && string.IsNullOrEmpty(_botWarning))
        {
            var random = new Random();
            _botWarning = BotWarnings[random.Next(BotWarnings.Length)];
        }
        else if (_suspicionLevel >= 6)
        {
            _isAiGame = true; // Mark as AI game to prevent score submission
        }
    }

    public void Dispose()
    {
        _timer?.Dispose();
        _aiCts?.Cancel();
    }
}
